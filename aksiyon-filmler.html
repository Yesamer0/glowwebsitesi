<!DOCTYPE html>
<html lang="tr" ng-app="GirisApp">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Aksiyon Filmler - GLOW</title>
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="stylesheet" href="assets/css/film-styles.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script src="assets/js/app.js"></script>
  </head>
  </head>
  <body ng-controller="AksiyonFilmlerController">
    <div ng-include="'components/header.html'"></div>

    <div class="filmler-container">
      <button class="geri-btn" onclick="window.history.back()" title="Geri D√∂n">
        ‚Üê
      </button>
      <h1 class="filmler-title">üí• Aksiyon Filmler</h1>

      <!-- Loading -->
      <div class="loading" ng-if="loading">
        <p>Filmler y√ºkleniyor...</p>
      </div>

      <!-- Error -->
      <div class="error" ng-if="error">
        <p>{{ error }}</p>
      </div>

      <!-- Filmler Grid -->
      <div class="filmler-grid" ng-if="!loading && !error">
        <div
          class="film-card"
          ng-repeat="film in filmler"
          ng-click="filmDetay(film.id)"
        >
          <img
            ng-src="{{ film.poster_url }}"
            ng-alt="{{ film.film_adi }}"
            class="film-poster"
            onerror="this.src='assets/images/logo.jpg'"
          />
          <div class="film-icerik">
            <!-- Film Takip Butonlarƒ± -->
            <div class="film-takip-actions" ng-if="kullanici" ng-click="$event.stopPropagation()">
              <button 
                class="film-takip-btn film-favori-btn" 
                ng-class="{'active': film.takipDurumu && film.takipDurumu.isFavorite}"
                ng-click="toggleFilmFavorite(film)"
                ng-disabled="film.takipLoading"
                title="Favorilere Ekle/√áƒ±kar"
              >
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
                {{film.takipDurumu && film.takipDurumu.isFavorite ? '‚ù§Ô∏è' : 'ü§ç'}}
              </button>
              
              <button 
                class="film-takip-btn film-izlenen-btn" 
                ng-class="{'active': film.takipDurumu && film.takipDurumu.isWatched}"
                ng-click="toggleFilmWatched(film)"
                ng-disabled="film.takipLoading"
                title="ƒ∞zlendi Olarak ƒ∞≈üaretle"
              >
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                </svg>
                {{film.takipDurumu && film.takipDurumu.isWatched ? '‚úÖ' : '‚≠ï'}}
              </button>
              
              <button 
                class="film-takip-btn film-izlenecek-btn" 
                ng-class="{'active': film.takipDurumu && film.takipDurumu.isWatchlist}"
                ng-click="toggleFilmWatchlist(film)"
                ng-disabled="film.takipLoading"
                title="ƒ∞zlenecekler Listesine Ekle"
              >
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                {{film.takipDurumu && film.takipDurumu.isWatchlist ? 'üìù' : '‚ûï'}}
              </button>
            </div>
            
            <div class="film-baslik">{{ film.film_adi }}</div>
            <div class="film-yil">{{ film.yil }}</div>
            <div class="film-imdb">IMDb: {{ film.imdb_puani }}</div>
            <div class="film-ozet">
              {{ film.ozet | limitTo: 100 }}{{ film.ozet.length > 100 ? '...' :
              '' }}
            </div>
            <button class="film-btn">Detaylarƒ± G√∂r</button>
          </div>
        </div>
      </div>
    </div>

    <div ng-include="'components/footer.html'"></div>
    
    <!-- Scroll to Top Button -->
    <button id="scrollTopBtn" title="Yukarƒ± √áƒ±k" ng-click="scrollToTop()">‚Üë</button>
  </body>
</html>

<script>
  angular
    .module("GirisApp")
    .controller("AksiyonFilmlerController", function ($scope, $http) {
      $scope.kullanici = JSON.parse(localStorage.getItem("girisYapan") || "null");
      $scope.loading = true;
      $scope.error = null;
      $scope.filmler = [];

      // Veritabanƒ±ndan filmleri √ßek
      $http
        .get("api.php?films=1&kategori=Aksiyon")
        .then(function (response) {
          $scope.filmler = response.data;
          $scope.loading = false;
          // Filmler y√ºklendikten sonra takip durumlarƒ±nƒ± y√ºkle
          $scope.filmTakipDurumlariniYukle();
        })
        .catch(function (error) {
          $scope.error =
            "Filmler y√ºklenirken hata olu≈ütu: " + error.data.message;
          $scope.loading = false;
        });

      // Film takip durumlarƒ±nƒ± y√ºkle
      $scope.filmTakipDurumlariniYukle = function() {
        if (!$scope.kullanici) return;
        
        $http.get('film_takip_api.php?user_id=' + $scope.kullanici.id)
          .then(function(response) {
            var filmler = response.data || [];
            $scope.filmler.forEach(function(film) {
              var mevcutFilm = filmler.find(function(f) {
                return f.title.toLowerCase() === film.film_adi.toLowerCase();
              });
              
              if (mevcutFilm) {
                film.takipDurumu = {
                  isFavorite: mevcutFilm.isFavorite,
                  isWatched: mevcutFilm.isWatched,
                  isWatchlist: !mevcutFilm.isWatched
                };
              } else {
                film.takipDurumu = {
                  isFavorite: false,
                  isWatched: false,
                  isWatchlist: false
                };
              }
              film.takipLoading = false;
            });
          })
          .catch(function(error) {
            console.error('Film takip durumlarƒ± y√ºklenirken hata:', error);
          });
      };

      // Favori durumunu deƒüi≈ütir
      $scope.toggleFilmFavorite = function(film) {
        if (!$scope.kullanici || film.takipLoading) return;
        
        film.takipLoading = true;
        var filmData = {
          user_id: $scope.kullanici.id,
          title: film.film_adi,
          year: film.yil,
          genre: film.tur,
          poster: film.poster_url,
          isFavorite: !film.takipDurumu.isFavorite,
          isWatched: film.takipDurumu.isWatched,
          rating: 0,
          review: ''
        };

        $http.post('film_takip_api.php', filmData)
          .then(function(response) {
            if (response.data.success) {
              film.takipDurumu.isFavorite = !film.takipDurumu.isFavorite;
              showMessage(film.takipDurumu.isFavorite ? 'Film favorilere eklendi' : 'Film favorilerden √ßƒ±karƒ±ldƒ±', 'success');
            }
          })
          .catch(function(error) {
            showMessage('ƒ∞≈ülem sƒ±rasƒ±nda hata olu≈ütu', 'error');
          })
          .finally(function() {
            film.takipLoading = false;
          });
      };

      // ƒ∞zlendi durumunu deƒüi≈ütir
      $scope.toggleFilmWatched = function(film) {
        if (!$scope.kullanici || film.takipLoading) return;
        
        film.takipLoading = true;
        var filmData = {
          user_id: $scope.kullanici.id,
          title: film.film_adi,
          year: film.yil,
          genre: film.tur,
          poster: film.poster_url,
          isFavorite: film.takipDurumu.isFavorite,
          isWatched: !film.takipDurumu.isWatched,
          rating: 0,
          review: ''
        };

        $http.post('film_takip_api.php', filmData)
          .then(function(response) {
            if (response.data.success) {
              film.takipDurumu.isWatched = !film.takipDurumu.isWatched;
              film.takipDurumu.isWatchlist = !film.takipDurumu.isWatched;
              showMessage(film.takipDurumu.isWatched ? 'Film izlendi olarak i≈üaretlendi' : 'Film izlendi listesinden √ßƒ±karƒ±ldƒ±', 'success');
            }
          })
          .catch(function(error) {
            showMessage('ƒ∞≈ülem sƒ±rasƒ±nda hata olu≈ütu', 'error');
          })
          .finally(function() {
            film.takipLoading = false;
          });
      };

      // ƒ∞zlenecek durumunu deƒüi≈ütir
      $scope.toggleFilmWatchlist = function(film) {
        if (!$scope.kullanici || film.takipLoading) return;
        
        film.takipLoading = true;
        var filmData = {
          user_id: $scope.kullanici.id,
          title: film.film_adi,
          year: film.yil,
          genre: film.tur,
          poster: film.poster_url,
          isFavorite: film.takipDurumu.isFavorite,
          isWatched: false,
          rating: 0,
          review: ''
        };

        $http.post('film_takip_api.php', filmData)
          .then(function(response) {
            if (response.data.success) {
              film.takipDurumu.isWatchlist = !film.takipDurumu.isWatchlist;
              film.takipDurumu.isWatched = false;
              showMessage(film.takipDurumu.isWatchlist ? 'Film izlenecekler listesine eklendi' : 'Film izlenecekler listesinden √ßƒ±karƒ±ldƒ±', 'success');
            }
          })
          .catch(function(error) {
            showMessage('ƒ∞≈ülem sƒ±rasƒ±nda hata olu≈ütu', 'error');
          })
          .finally(function() {
            film.takipLoading = false;
          });
      };

      $scope.filmDetay = function (filmId) {
        window.location.href = "film-detay.html?id=" + filmId;
      };

      $scope.scrollToTop = function () {
        window.scrollTo({ top: 0, behavior: "smooth" });
      };
    });
</script>
